name: test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  laravel-tests:

    runs-on: ubuntu-latest
    
    steps:
    - name: deps
      run: |
        sudo apt-get install -y snmp fping python3-pip python3-setuptools
        mysql -e 'CREATE DATABASE librenms_phpunit_78hunjuybybh CHARACTER SET utf8 COLLATE utf8_unicode_ci;'
        pip3 install --user snmpsim
        pip install --user mysql-python pylint        
    - name: Setup MySQL
      uses: mirromutth/mysql-action@v1.1
      with:
        # The port of host
        #host port: # optional, default is 3306
        # The port of container
        #container port: # optional, default is 3306
        # --character-set-server - The character set of MySQL server
        #character set server: # optional, default is utf8mb4
        # --collation-server - The character collation of MySQL server
        #collation server: # optional, default is utf8mb4_general_ci
        # Version of MySQL to use
        #mysql version: # optional, default is latest
        # MYSQL_ROOT_PASSWORD - root superuser password
        mysql root password: '' # optional, default is 
        # MYSQL_DATABASE - name for the default database that is created
        #mysql database: # optional, default is 
        # MYSQL_USER - create the specified user with superuser power for created database
        #mysql user: # optional, default is 
        # MYSQL_PASSWORD - specified superuser password which user is power for created database
        #mysql password: # optional, default is 
    - uses: actions/checkout@v2
    - name: Copy .env
      run: cp tests/config/config.test.php config.php
    - name: Install Dependencies
      run: composer install -q --no-ansi --no-interaction --no-scripts --no-suggest --no-progress --prefer-dist
    - name: Directory Permissions
      run: chmod -R 777 storage bootstrap/cache

    - name: Execute tests (Unit and Feature tests) via PHPUnit
      env:
        APP_ENV: testing
      run: |
        set -e
        export FILES=$(git diff --diff-filter=d --name-only master | tr '\n' ' '|sed 's/,*$//g')
        php scripts/pre-commit.php -q -l
        php scripts/pre-commit.php -q -s
        php scripts/pre-commit.php -u --db --snmpsim --fail-fast
        test -z "$BROWSER_TEST" || php artisan dusk
        bash -n daily.sh
        pylint -E poller-wrapper.py discovery-wrapper.py
        bash scripts/deploy-docs.sh
        set +e
